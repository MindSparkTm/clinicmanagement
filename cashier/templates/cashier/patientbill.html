{% extends "base.html" %} {% load static %}
{% static  'css/style.css' %}

{% block content %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.css">
<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>

<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/2.3.2/jspdf.plugin.autotable.js"></script>
    <script type="text/javascript" src="{% static 'js/choosen.js' %}"></script>
       <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-red.min.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">


                <legend style="padding: 20px; ">Cashier Form</legend>




           <form method="post" action="/cashier/patientbill/">
    {% csrf_token %}


                {{ form.patientid }}
      <br>
      {{ form.totalbill }}
      <br>
      {{ form.invoiceid }}
      <br>
      {{ form.billbreakdown }}
      <br>






   <label  style="font-weight: bold;">Choose a service </label>  <select  id ="service" style="width: 50%;height: 30px;margin-left: 75px" onchange="getpriceperservice(this.value)" >



<option selected> -- select an option -- </option>




  </select>
      </br></br>

      <input type="submit" class="mdl-button mdl-js-ripple-effect mdl-js-button mdl-button--raised mdl-button--colored mdl-color--primary" id="saveinfo" name="saveinfo" value="Generate Invoice">

           </form>
        </div>


</div>









              <div>
   <table id="demotbl" class="display" cellspacing="0" width="50%">
    <thead>
        <tr>
            <th>Service Type</th>
            <th>Price</th>
            <th>Delete</th>









        </tr>
    </thead>
</table>

</div>



          </div>

        </div>

      </main>
    </div>

    <a href="https://github.com/google/material-design-lite/blob/mdl-1.x/templates/article/" target="_blank" id="view-source" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-color--accent mdl-color-text--accent-contrast">View Source</a>
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>




</body>
<script type="text/javascript">
    var total =0;
    var services =[]
    var prices =[]
    var patientid = $('#patientid').val();

$(document).ready(function(){

    var timestamp = new Date().getUTCMilliseconds();
    console.log('invoiceid','IN-'+timestamp)
    $('#invoiceid').val('IN-'+timestamp);


   var tbl=  $('#demotbl').DataTable({


                    "aoColumns": [
                        {"sTitle": "Service"},
                        {"sTitle": "Price"},

                        {
                            "targets": -3,
                            "data": null,
                            "defaultContent": "<button id='btn' name='btn'>Delete</button>"
                        },



                        ]

                });

    $('#demotbl tbody').on( 'click', 'button', function (e) {
            var table = $('#demotbl').DataTable();

        e.preventDefault();
        console.log('selected')
        var tr = $(this).closest('tr');
        var rows = table.row(tr);

        var info = rows.data();

        var price= parseFloat(info[1]);
        console.log('price',price)
        var updatedamount = parseFloat($('#totalbill').val());
        console.log('updatedamount',updatedamount)

       updatedamount = updatedamount - price
        total = total - price

        if(updatedamount<=0){
            $('#totalbill').val(0);

        }
        else{
            $('#totalbill').val(updatedamount);

        }

    table
        .row( $(this).parents('tr') )
        .remove()
        .draw();

   if ( ! table.data().count() ) {
       $('#service').val('Choose a service')
}

      $('#billbreakdown').val('');
   var data = table
    .rows()
    .data();
        var d = $('#billbreakdown').val();

for(var i=0;i<data.length;i++){
    for(var j=0;j<2;j++){
        d = d + data[i][j]+";";
        $('#billbreakdown').val(d);

    }
}




      // demoFromHTML(dat)






    } );





$.ajax({
        url: "/billing/api/v1/billingservice/",
        type: "GET",
        success: function (response) {
            s = response;
            console.log("s", response);
            $.each(response, function (i, item) {
                $('#service').append($('<option>', {
                    value: item.service,
                    text: item.service,
                }))
            })
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
        }


    });





})



function getpriceperservice(servicedata){
    console.log('I have been called')
    $.ajax({
        url: "/billing/api/v1/billingservice/",
        type: "GET",
         data: {
             search: servicedata
                    },
        success: function (response) {

            s = response;
            var breakdown = $('#billbreakdown').val();

            console.log('this',response)
            for(var i=0;i<response.length;i++){
                total = total + parseFloat(response[i].price)
                if(breakdown.length>0) {
                    $('#billbreakdown').val(breakdown+'\n' + response[i].service + ';' + response[i].price+";")

                }
                else{
                    $('#billbreakdown').val(response[i].service + ';' + response[i].price+";"+'\n')

                }

            }

            $('#totalbill').val(total)
            var data = jQuery.map(response, function (el, i) {
                return [[el.service, el.price, 'delete']];
            });
            var table = $('#demotbl').DataTable();

            table.rows.add(data);
            table.draw();

            console.log('data',data);







        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
        }









    });


}

function generatepdf(){
        var columns = []


// Only pt supported (not mm or in)
    var table = $('#demotbl').DataTable();

var data = table
    .rows()
    .data();

for(var i=0;i<data.length;i++){
    for(var j=0;j<2;j++){
        console.log(data[i][j])

    }
}


}
$('#printinfo').click(function(e){
    e.preventDefault();
    window.open('invoicepdf')

})





</script>
{% endblock %}